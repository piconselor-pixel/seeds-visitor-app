<!DOCTYPE html>
<html lang="en">
<head>
  <title>üîê Seeds FinCap - Security Dashboard</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    .header {
      background: white;
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    .header h1 { color: #007bff; font-size: 2.2em; margin-bottom: 10px; }
    .header p { color: #555; }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 18px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(102,126,234,0.4);
    }
    .stat-number { font-size: 2.5em; font-weight: bold; margin-bottom: 8px; }
    .stat-label { opacity: 0.95; }
    .controls {
      background: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .controls input, .controls select {
      padding: 10px 14px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 14px;
    }
    .btn {
      padding: 10px 18px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      text-decoration: none;
    }
    .btn:hover { background: #0056b3; }
    .btn-success { background: #28a745; }
    .btn-success:hover { background: #1e7e34; }
    table {
      width: 100%;
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      border-collapse: collapse;
    }
    th {
      background: linear-gradient(45deg, #007bff, #0056b3);
      color: white;
      padding: 14px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
    }
    td {
      padding: 12px 14px;
      border-bottom: 1px solid #f1f3f4;
      font-size: 14px;
    }
    tr:hover { background: #f8f9fa; }
    .status-checked_in { color: #28a745; font-weight: 600; }
    .status-checked_out { color: #6c757d; font-weight: 600; }
    .action-btn {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      margin-right: 5px;
      margin-bottom: 3px;
    }
    .action-checkout { background: #28a745; color: white; }
    .action-wa { background: #25D366; color: white; }
    .logout {
      position: fixed;
      right: 20px;
      top: 20px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
    }
    .hidden { display: none; }
    .status-bar {
      margin-top: 10px;
      font-size: 13px;
      color: #dc3545;
    }
    @media (max-width: 768px) {
      .header, .controls { padding: 15px; }
      th, td { font-size: 12px; padding: 10px; }
    }
  </style>
</head>
<body>
  <button class="logout hidden" id="logoutBtn" onclick="logout()">üö™ Logout</button>

  <div class="container">
    <!-- Login Box -->
    <div id="loginBox" class="header">
      <h1>üîê Admin Login</h1>
      <p>Seeds FinCap Visitor Security Dashboard</p>
      <div style="max-width: 400px; margin: 20px auto 0;">
        <input type="text" id="loginUsername" placeholder="admin@seedsfincap.com"
               style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd;">
        <input type="password" id="loginPassword" placeholder="admin123"
               style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd;">
        <button class="btn" style="width: 100%;" onclick="adminLogin()">Login</button>
        <div id="loginStatus" class="status-bar"></div>
        <p style="margin-top: 10px; color: #666; font-size: 13px;">
          Default: admin@seedsfincap.com / admin123
        </p>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
      <div class="header">
        <h1>üîê Security Control Center</h1>
        <p>Real-time visitor monitoring and audit</p>
        <div id="userInfo" style="margin-top: 8px; font-size: 13px; color: #555;"></div>
      </div>

      <div class="stats-grid" id="statsGrid"></div>

      <div class="controls">
        <input type="date" id="dateFilter">
        <select id="statusFilter">
          <option value="">All Visitors</option>
          <option value="checked_in">Active (Checked-in)</option>
          <option value="checked_out">Checked-out</option>
        </select>
        <button class="btn" onclick="loadVisitors()">üîÑ Refresh</button>
        <a href="#" class="btn btn-success" id="exportBtn" onclick="exportCSV(event)">üìä Export 7-Day CSV</a>
        <span id="filterStatus" style="margin-left:auto; font-size: 13px; color:#555;"></span>
      </div>

      <table id="visitorsTable">
        <thead>
          <tr>
            <th>Check-in</th>
            <th>Name</th>
            <th>Mobile</th>
            <th>Host</th>
            <th>Email</th>
            <th>Purpose</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="dashboardStatus" class="status-bar"></div>
    </div>
  </div>

  <script>
    let adminToken = localStorage.getItem('adminToken') || null;
    let currentUser = null;

    // On load: if token exists, try to load stats; if 403/401, clear token
    window.addEventListener('load', async () => {
      if (adminToken) {
        const ok = await tryLoadDashboardWithToken();
        if (!ok) {
          adminToken = null;
          localStorage.removeItem('adminToken');
          showLogin();
        }
      } else {
        showLogin();
      }
    });

    function showLogin() {
      document.getElementById('loginBox').classList.remove('hidden');
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('logoutBtn').classList.add('hidden');
    }

    function showDashboard() {
      document.getElementById('loginBox').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      document.getElementById('logoutBtn').classList.remove('hidden');
    }

    async function adminLogin() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;

      const statusEl = document.getElementById('loginStatus');
      statusEl.textContent = 'Logging in...';

      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        console.log('Login response:', data);

        if (!res.ok) {
          statusEl.textContent = data.error || 'Login failed';
          return;
        }

        if (!data.user || data.user.role !== 'admin') {
          statusEl.textContent = 'Admin access required (role is not admin)';
          return;
        }

        adminToken = data.token;
        currentUser = data.user;
        localStorage.setItem('adminToken', adminToken);

        document.getElementById('userInfo').textContent =
          `Logged in as ${currentUser.username} (role: ${currentUser.role})`;

        statusEl.textContent = '';
        showDashboard();
        await loadStats();
        await loadVisitors();
      } catch (err) {
        console.error('Login error:', err);
        statusEl.textContent = 'Error: ' + err.message;
      }
    }

    async function tryLoadDashboardWithToken() {
      try {
        const res = await fetch('/api/admin/stats', {
          headers: { 'Authorization': 'Bearer ' + adminToken }
        });
        if (!res.ok) return false;
        const stats = await res.json();
        currentUser = { username: 'admin', role: 'admin' }; // minimal
        document.getElementById('userInfo').textContent =
          `Logged in as ${currentUser.username} (role: ${currentUser.role})`;
        showDashboard();
        renderStats(stats);
        await loadVisitors();
        return true;
      } catch (err) {
        console.error('Token check error:', err);
        return false;
      }
    }

    async function loadStats() {
      const status = document.getElementById('dashboardStatus');
      status.textContent = '';
      try {
        const res = await fetch('/api/admin/stats', {
          headers: { 'Authorization': 'Bearer ' + adminToken }
        });
        const data = await res.json();
        if (!res.ok) {
          status.textContent = data.error || 'Failed to load stats';
          return;
        }
        renderStats(data);
      } catch (err) {
        console.error('Stats error:', err);
        status.textContent = 'Error loading stats: ' + err.message;
      }
    }

    function renderStats(data) {
      const s = data.today || { total_today: 0, active: 0, checked_out: 0 };
      const all = data.allTime || 0;
      document.getElementById('statsGrid').innerHTML = `
        <div class="stat-card">
          <div class="stat-number">${s.total_today}</div>
          <div class="stat-label">Visitors Today</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${s.active}</div>
          <div class="stat-label">Active (Checked-in)</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${s.checked_out}</div>
          <div class="stat-label">Checked-out Today</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${all}</div>
          <div class="stat-label">Total Visitors (All Time)</div>
        </div>
      `;
    }

    async function loadVisitors() {
      const status = document.getElementById('dashboardStatus');
      status.textContent = '';

      const date = document.getElementById('dateFilter').value;
      const st = document.getElementById('statusFilter').value;
      const params = new URLSearchParams();
      if (date) params.append('date', date);
      if (st) params.append('status', st);

      document.getElementById('filterStatus').textContent =
        `Filter: ${date || 'Any Date'} | ${st || 'All Status'}`;

      try {
        const res = await fetch('/api/visitors?' + params.toString(), {
          headers: { 'Authorization': 'Bearer ' + adminToken }
        });
        const visitors = await res.json();
        if (!res.ok) {
          status.textContent = visitors.error || 'Failed to load visitors';
          return;
        }

        const tbody = document.querySelector('#visitorsTable tbody');
        if (!visitors.length) {
          tbody.innerHTML = '<tr><td colspan="8">No visitors found for current filter</td></tr>';
          return;
        }

        tbody.innerHTML = visitors.map(v => `
          <tr>
            <td>${new Date(v.checkin_time).toLocaleString()}</td>
            <td>${v.visitor_name}</td>
            <td>${v.mobile || ''}</td>
            <td>${v.host_employee || ''}</td>
            <td>${v.host_email}</td>
            <td>${(v.purpose || '').substring(0,50)}${(v.purpose || '').length > 50 ? '‚Ä¶' : ''}</td>
            <td class="status-${v.status}">${v.status.replace('_', ' ').toUpperCase()}</td>
            <td>
              ${v.status === 'checked_in'
                ? `<button class="action-btn action-checkout" onclick="checkoutVisitor(${v.id})">Check-out</button>`
                : ''
              }
              ${v.mobile
                ? `<a class="action-btn action-wa" target="_blank"
                       href="https://wa.me/91${v.mobile}?text=Your%20visit%20status:%20${encodeURIComponent(v.status)}">
                     WhatsApp
                   </a>`
                : ''
              }
            </td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Visitors error:', err);
        status.textContent = 'Error loading visitors: ' + err.message;
      }
    }

    async function checkoutVisitor(id) {
      if (!confirm('Mark this visitor as checked-out?')) return;
      const status = document.getElementById('dashboardStatus');
      try {
        const res = await fetch('/api/visitors/' + id + '/checkout', {
          method: 'PUT',
          headers: { 'Authorization': 'Bearer ' + adminToken }
        });
        const data = await res.json();
        if (!res.ok) {
          status.textContent = data.error || 'Checkout failed';
          return;
        }
        await loadStats();
        await loadVisitors();
      } catch (err) {
        console.error('Checkout error:', err);
        status.textContent = 'Error: ' + err.message;
      }
    }

    function exportCSV(e) {
      e.preventDefault();
      if (!adminToken) return alert('Login as admin first');
      // Open in new tab with token in header not possible; use simple fetch + blob download
      fetch('/api/admin/export', {
        headers: { 'Authorization': 'Bearer ' + adminToken }
      }).then(res => res.blob())
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'Seeds-Security-Audit.csv';
          document.body.appendChild(a);
          a.click();
          a.remove();
        }).catch(err => alert('Export failed: ' + err.message));
    }

    function logout() {
      adminToken = null;
      currentUser = null;
      localStorage.removeItem('adminToken');
      showLogin();
    }

    // Auto refresh stats & visitors every 30s while dashboard visible
    setInterval(() => {
      if (!adminToken || document.getElementById('dashboard').classList.contains('hidden')) return;
      loadStats();
      loadVisitors();
    }, 30000);

    // Enter key on login
    document.addEventListener('keypress', e => {
      if (e.key === 'Enter' && !document.getElementById('loginBox').classList.contains('hidden')) {
        adminLogin();
      }
    });
  </script>
</body>
</html>